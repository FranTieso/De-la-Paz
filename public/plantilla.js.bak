
document.addEventListener("DOMContentLoaded", () => {
    // --- 1. INICIALIZACIÓN DE FIREBASE (MÁXIMA PRIORIDAD) ---
    // Esto asegura que Firebase esté listo para cualquier script que lo necesite.
    if (!firebase.apps.length) {
        firebase.initializeApp({
            apiKey: "AIzaSyCmr1oZFjzao2rGMDmWFN82gdLED0ODqaE",
            authDomain: "de-la-paz-4f635.firebaseapp.com",
            projectId: "de-la-paz-4f635",
            storageBucket: "de-la-paz-4f635.firebasestorage.app",
            messagingSenderId: "713257869341",
            appId: "1:713257869341:web:118f3e3414c8daa6c566f4",
            measurementId: "G-42Q79PD42K"
        });
    }
    const auth = firebase.auth();
    // Se dispara el evento para que las páginas (ej: categorias.html) sepan que pueden consultar la DB.
    document.dispatchEvent(new Event('firebaseReady'));

    // --- 2. GESTIÓN CENTRALIZADA DE LA UI DE AUTENTICACIÓN ---
    const updateUserUI = (user) => {
        const elements = {
            userArea: document.getElementById('user-area'),
            mobileUserArea: document.getElementById('mobile-user-area'),
            loginBtn: document.getElementById('login-btn'),
            mobileLoginBtn: document.getElementById('mobile-login-btn'),
            loginCard: document.getElementById('login-card')
        };

        if (user) {
            const userDisplay = `<span class="font-semibold text-primary">${user.email}</span>`;
            const logoutButton = `<button id="logout-btn" class="ml-4 font-semibold text-red-500 hover:text-red-700">Salir</button>`;
            if (elements.userArea) elements.userArea.innerHTML = userDisplay + logoutButton;
            if (elements.mobileUserArea) elements.mobileUserArea.innerHTML = userDisplay + logoutButton;
            document.querySelectorAll('#logout-btn').forEach(btn => btn.addEventListener('click', () => auth.signOut()));
        } else {
            if (elements.userArea) elements.userArea.innerHTML = '';
            if (elements.mobileUserArea) elements.mobileUserArea.innerHTML = '';
        }

        if (elements.loginBtn) elements.loginBtn.style.display = user ? 'none' : 'block';
        if (elements.mobileLoginBtn) elements.mobileLoginBtn.style.display = user ? 'none' : 'block';
        if (elements.loginCard) elements.loginCard.style.display = user ? 'none' : 'block';
    };
    auth.onAuthStateChanged(updateUserUI);

    // --- 3. CARGA DE PLANTILLAS Y LÓGICA DE UI ESPECIALIZADA ---
    const navContainer = document.getElementById("nav-container");
    if (navContainer) {
        fetch("nav.html")
            .then(res => res.ok ? res.text() : Promise.reject('nav.html not found'))
            .then(data => {
                navContainer.innerHTML = data;
                const currentPage = window.location.pathname.split("/").pop() || "index.html";
                document.querySelectorAll("#nav-links a, #mobile-menu a").forEach(link => {
                    if (link.href.endsWith(currentPage)) link.classList.add("text-secondary", "font-bold");
                });

                const menuBtn = document.getElementById("menu-btn");
                const mobileMenu = document.getElementById("mobile-menu");
                if(menuBtn && mobileMenu) menuBtn.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));

                const loginModal = document.getElementById("login-modal");
                const loginForm = document.getElementById("login-form");
                const showLoginModal = e => { e.preventDefault(); loginModal && loginModal.classList.remove("hidden"); };
                document.querySelectorAll('#login-btn, #mobile-login-btn, #login-card').forEach(item => item.addEventListener('click', showLoginModal));
                document.getElementById("close-login")?.addEventListener("click", () => loginModal.classList.add("hidden"));
                
                if (loginForm) {
                    loginForm.addEventListener("submit", (e) => {
                        e.preventDefault();
                        auth.signInWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value)
                            .then(() => loginModal && loginModal.classList.add("hidden"))
                            .catch(err => alert("Error: " + err.message));
                    });
                }
                
                // Forzar actualización de UI de usuario ahora que el NAV está en el DOM
                updateUserUI(auth.currentUser);
            })
            .catch(err => console.error("Error loading nav:", err));
    }

    const footerContainer = document.getElementById("footer-container");
    if (footerContainer) {
        fetch("footer.html")
            .then(res => res.ok ? res.text() : '')
            .then(data => { footerContainer.innerHTML = data; })
            .catch(err => console.error("Error loading footer:", err));
    }
});
